# 員林基督教醫院自動掛號系統

為 80 歲媽媽自動掛劉又綾醫師的號

## 快速使用

### 1. 安裝依賴

```bash
cd auto-booking
npm install
```

### 2. 立即執行掛號檢查

```bash
node quick-booking.js
```

### 3. 啟動智能掛號系統

```bash
npm start
```

程序會詢問運行模式：

- **模式1**: 依日期選擇可用的醫師 (手動選擇)
- **模式2**: 依config自動尋找劉又綾醫師 (自動模式)
- **按 Enter**: 取消掛號 (媽媽要去買菜時使用)

### 4. 搜尋醫師工具

```bash
node find-doctor.js
```

## 程式說明

### 主要檔案

- **`booking.js`**: 主程式，支援排程和兩種掛號模式
- **`quick-booking.js`**: 快速測試版本，立即執行一次檢查
- **`find-doctor.js`**: 醫師搜尋工具，自動搜尋所有日期範圍

### 智能功能

- 🤖 **自動填寫表單**: 病歷號、生日、掛號類別
- 🔍 **智能醫師搜尋**: 支援醫師名稱和代碼搜尋
- ⏰ **定時監控**: 每天 8:00, 12:00, 18:00 自動檢查
- 🎯 **精準匹配**: 找到可掛號時段才進入填寫頁面
- 🚪 **自動結束**: 沒找到可掛號時段自動關閉程序

## 掛號資訊

- **醫師**: 劉又綾 (代碼: 0055881)
- **病歷號**: P200289819
- **生日**: 07/06

## 使用流程

1. 執行 `npm start`
2. 選擇運行模式 (1/2 或按 Enter 取消)
3. 程序自動檢查所有可選日期
4. 找到可掛號時段會自動填寫表單
5. 手動檢查資料並提交掛號
6. 沒找到時程序自動結束

## 注意事項

- ✅ 程序會自動檢查所有可選日期範圍
- ✅ 找到劉又綾醫師可掛號時段會自動填寫表單
- ✅ 支援手動選擇其他醫師 (模式1)
- ✅ 建議在網路穩定時執行
- ✅ 首次使用建議用 `quick-booking.js` 測試
- ✅ 媽媽要買菜時按 Enter 即可取消

## 技術特色

- 🔧 **智能表單識別**: 支援多種輸入框選擇器
- 🎛️ **雙模式運行**: 自動模式 + 手動選擇模式
- 🔄 **自動重試機制**: 定時排程持續監控
- 💻 **用戶友好介面**: 清晰的操作提示和狀態顯示
- 🛡️ **錯誤處理**: 網路異常和頁面變化的容錯處理

## 新增功能 (2026-02-03)

### 🚀 自動提交功能

- 設定 `config.autoSubmit: true` 啟用自動提交
- 系統會自動點擊 `#BtOK` 按鈕提交表單
- 自動處理 `window.confirm` 確認彈窗

### 📧 郵件通知功能

- 提交後自動解析 `#Table7` 結果表格
- 提取掛號結果資訊：身份證、病歷號碼、民眾姓名、醫師姓名、預約時間、看診時段、預約結果、診間位置
- 格式化為 HTML 郵件發送通知

### ⚙️ 新增 Config 設定

```javascript
{
  autoSubmit: true,                    // 是否自動提交
  sendMailTo: "cn27529@gmail.com",     // 收件人
  mailSubject: "幫媽媽自動掛號系統",    // 郵件主旨
  mailFrom: "cn27529@gmail.com"        // 寄件人
}
```

### 🔧 環境變數設定

1. 複製 `.env.example` 為 `.env`
2. 設定 Gmail 應用程式密碼：
   - 前往 Google 帳戶設定 → 安全性 → 兩步驟驗證
   - 產生應用程式密碼
   - 將密碼填入 `GMAIL_APP_PASSWORD`

### 📋 新功能使用流程

1. 自動填寫表單
2. 如果 `autoSubmit: true`：
   - 自動點擊提交按鈕
   - 自動處理 `window.confirm` 確認彈窗
   - 解析結果並發送郵件通知
   - **如果預約結果包含"已預約為"，程序自動退出**
3. 如果 `autoSubmit: false`：
   - 僅填寫表單，等待手動提交

## 最新更新 (2026-02-03 19:36)

### ✅ 智能退出機制

- 檢測預約結果中的"已預約為??????"字符 → 掛號成功自動退出
- 檢測預約結果中的"重覆掛號?????"字符 → 重複掛號自動退出
- 兩種情況都會發送對應的通知郵件

### 🤖 完全自動化測試通過

- ✅ `window.confirm` 彈窗完全自動處理
- ✅ 掛號成功自動退出測試通過
- ✅ 重複掛號自動退出測試通過
- 🎉 **無需手動干預，完全自動化運行**

### 📧 智能郵件通知

- 掛號成功：`掛號成功通知 ✅`
- 重複掛號：`重複掛號通知 ⚠️`
- 收到郵件即知結果，無需查看程序狀態
