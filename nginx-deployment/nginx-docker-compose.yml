version: '3.8'

services:
  # Nginx 反向代理
  nginx:
    image: nginx:alpine
    container_name: zhengkuo-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx-config.conf:/etc/nginx/conf.d/default.conf:ro
      - ./client/dist:/var/www/html:ro
      - ./ssl:/etc/nginx/ssl:ro
      - nginx-logs:/var/log/nginx
    depends_on:
      - rust-backend
      - log-server
      - docs-server
    networks:
      - zhengkuo-network
    restart: unless-stopped

  # Rust 後端
  rust-backend:
    build:
      context: ./rust-axum
      dockerfile: Dockerfile
    container_name: zhengkuo-rust
    ports:
      - "3000:3000"
    volumes:
      - ./rust-axum/data:/app/data
    environment:
      - DATABASE_URL=/app/data/current.db
      - RUST_LOG=info
    networks:
      - zhengkuo-network
    restart: unless-stopped

  # 日誌服務器
  log-server:
    build:
      context: ./log-server
      dockerfile: Dockerfile
    container_name: zhengkuo-logs
    ports:
      - "3002:3002"
    environment:
      - MONGODB_URI=${MONGODB_URI}
      - NODE_ENV=production
    networks:
      - zhengkuo-network
    restart: unless-stopped

  # 文檔服務器
  docs-server:
    build:
      context: ./docs
      dockerfile: Dockerfile
    container_name: zhengkuo-docs
    ports:
      - "3001:3001"
    volumes:
      - ./docs:/app/docs:ro
    networks:
      - zhengkuo-network
    restart: unless-stopped

  # Directus (可選)
  directus:
    image: directus/directus:latest
    container_name: zhengkuo-directus
    ports:
      - "8055:8055"
    volumes:
      - directus-data:/directus/database
      - directus-uploads:/directus/uploads
    environment:
      KEY: ${DIRECTUS_KEY}
      SECRET: ${DIRECTUS_SECRET}
      DB_CLIENT: sqlite3
      DB_FILENAME: /directus/database/data.db
      ADMIN_EMAIL: ${DIRECTUS_ADMIN_EMAIL}
      ADMIN_PASSWORD: ${DIRECTUS_ADMIN_PASSWORD}
    networks:
      - zhengkuo-network
    restart: unless-stopped

volumes:
  nginx-logs:
  directus-data:
  directus-uploads:

networks:
  zhengkuo-network:
    driver: bridge
