# å®¢æˆ¶è³‡æ–™åº«åˆå§‹åŒ–å·¥å…·æŒ‡å—

## æ¦‚è¿°

`scripts/init-database.js` æ˜¯å°ˆé–€ç”¨æ–¼åˆå§‹åŒ–æ–°å®¢æˆ¶è³‡æ–™åº«çš„å·¥å…·ã€‚å®ƒæœƒè®€å– `db/databases.json` é…ç½®æª”æ¡ˆï¼Œè‡ªå‹•è­˜åˆ¥æœªåˆå§‹åŒ–çš„è³‡æ–™åº«ï¼Œä¸¦æä¾›å¤šç¨®åˆå§‹åŒ–æ–¹å¼ã€‚

## åŠŸèƒ½ç‰¹è‰²

### æ™ºæ…§é…ç½®è®€å–
- è‡ªå‹•å°‹æ‰¾ `databases.json` é…ç½®æª”æ¡ˆï¼ˆå„ªå…ˆç´šé †åºèˆ‡ start-with-db.js ç›¸åŒï¼‰
- è§£æé…ç½®ä¸¦è™•ç†è·¯å¾‘æ ¼å¼
- è‡ªå‹•è™•ç† `db/` è·¯å¾‘å‰ç¶´

### è³‡æ–™åº«ç‹€æ…‹åˆ†æ
- æª¢æŸ¥æ‰€æœ‰é…ç½®è³‡æ–™åº«çš„åˆå§‹åŒ–ç‹€æ…‹
- é¡¯ç¤ºæª”æ¡ˆå¤§å°å’Œå­˜åœ¨ç‹€æ…‹
- è‡ªå‹•éæ¿¾å·²å®Œæˆåˆå§‹åŒ–çš„è³‡æ–™åº«

### å¤šç¨®åˆå§‹åŒ–æ–¹å¼
- **ç¯„æœ¬è¤‡è£½**ï¼šå¾å·²åˆå§‹åŒ–çš„è³‡æ–™åº«è¤‡è£½ï¼ˆæ¨è–¦ï¼‰
- **Directus åˆå§‹åŒ–**ï¼šå…¨æ–°å»ºç«‹ä¸¦è¨­å®šç®¡ç†å“¡å¸³è™Ÿ

## ä½¿ç”¨æ–¹å¼

### å•Ÿå‹•åˆå§‹åŒ–å·¥å…·

```bash
node scripts/init-database.js
```

### å·¥å…·æµç¨‹

1. **é…ç½®æª¢æŸ¥**
   - è‡ªå‹•å°‹æ‰¾ä¸¦è¼‰å…¥ `databases.json` é…ç½®æª”
   - é¡¯ç¤ºå°ˆæ¡ˆæ ¹ç›®éŒ„å’Œé…ç½®æª”è·¯å¾‘

2. **è³‡æ–™åº«ç‹€æ…‹åˆ†æ**
   - æƒææ‰€æœ‰é…ç½®çš„å®¢æˆ¶è³‡æ–™åº«
   - æª¢æŸ¥åŸºç¤è³‡æ–™åº«ç‹€æ…‹
   - é¡¯ç¤ºè©³ç´°çš„ç‹€æ…‹å ±å‘Š

3. **é¸æ“‡å¾…åˆå§‹åŒ–è³‡æ–™åº«**
   - åªé¡¯ç¤ºæœªåˆå§‹åŒ–çš„è³‡æ–™åº«é¸é …
   - æä¾›æ¸…æ¥šçš„ç‹€æ…‹èªªæ˜

4. **é¸æ“‡åˆå§‹åŒ–æ–¹å¼**
   - åˆ—å‡ºå¯ç”¨çš„ç¯„æœ¬è³‡æ–™åº«
   - æä¾› Directus åˆå§‹åŒ–é¸é …

## ç‹€æ…‹é¡¯ç¤ºç¯„ä¾‹

```
ğŸ“Š ç¾æœ‰è³‡æ–™åº«ç‹€æ…‹:
============================================================
é®åœ‹å¯º           zk.db                2.45 MB  âœ“ å·²åˆå§‹åŒ–
ç´«é›²å¯º           ziyun.db             N/A      âŒ ä¸å­˜åœ¨
å°‘æ—å¯º           shaolin.db           0.12 MB  âœ— æœªåˆå§‹åŒ–
åŸºç¤è³‡æ–™åº«        data.db              1.23 MB  âœ“ å·²åˆå§‹åŒ–
============================================================
```

## åˆå§‹åŒ–é¸å–®ç¯„ä¾‹

```
ğŸ—ï¸ è«‹é¸æ“‡è¦åˆå§‹åŒ–çš„å®¢æˆ¶è³‡æ–™åº«:
==================================================
1. ç´«é›²å¯º (ziyun.db) ğŸ†•
   æè¿°: ç´«é›²å¯ºå®¢æˆ¶è³‡æ–™åº«
   ç‹€æ…‹: ä¸å­˜åœ¨ï¼Œå°‡å»ºç«‹

2. å°‘æ—å¯º (shaolin.db) âš ï¸
   æè¿°: å°‘æ—å¯ºå®¢æˆ¶è³‡æ–™åº«
   ç‹€æ…‹: æœªåˆå§‹åŒ–

3. å–æ¶ˆæ“ä½œ
```

## ç¯„æœ¬é¸æ“‡ç¯„ä¾‹

```
ğŸ“‹ è«‹é¸æ“‡ç¯„æœ¬è³‡æ–™åº«:
==================================================
1. é®åœ‹å¯º (zk.db)
   å¤§å°: 2.45 MB

2. åŸºç¤è³‡æ–™åº« (data.db)
   å¤§å°: 1.23 MB

3. ä½¿ç”¨ Directus åˆå§‹åŒ–ï¼ˆæ…¢ï¼Œéœ€è¦è¨­å®šç®¡ç†å“¡ï¼‰
4. å–æ¶ˆ
```

## åˆå§‹åŒ–æ–¹å¼

### ç¯„æœ¬è¤‡è£½ï¼ˆæ¨è–¦ï¼‰

**å„ªé»**ï¼š
- å¿«é€Ÿå®Œæˆåˆå§‹åŒ–
- ä¿ç•™å®Œæ•´çš„è³‡æ–™çµæ§‹å’Œè¨­å®š
- åŒ…å«é è¨­è³‡æ–™å’Œé…ç½®

**é©ç”¨æƒ…æ³**ï¼š
- éœ€è¦èˆ‡ç¾æœ‰è³‡æ–™åº«ç›¸åŒçš„çµæ§‹
- å¿«é€Ÿå»ºç«‹æ¸¬è©¦ç’°å¢ƒ
- æ¨™æº–åŒ–çš„å®¢æˆ¶è³‡æ–™åº«

**æ“ä½œæµç¨‹**ï¼š
1. é¸æ“‡è¦åˆå§‹åŒ–çš„è³‡æ–™åº«
2. é¸æ“‡ç¯„æœ¬è³‡æ–™åº«
3. è‡ªå‹•è¤‡è£½ä¸¦å®Œæˆåˆå§‹åŒ–

### Directus åˆå§‹åŒ–

**å„ªé»**ï¼š
- å…¨æ–°ä¹¾æ·¨çš„è³‡æ–™åº«
- å¯è‡ªè¨‚ç®¡ç†å“¡å¸³è™Ÿ
- å®Œæ•´çš„ Directus è¨­å®šæµç¨‹

**é©ç”¨æƒ…æ³**ï¼š
- éœ€è¦å…¨æ–°çš„è³‡æ–™åº«çµæ§‹
- ç‰¹æ®Šçš„å®¢æˆ¶éœ€æ±‚
- æ¸¬è©¦ä¸åŒçš„é…ç½®

**æ“ä½œæµç¨‹**ï¼š
1. é¸æ“‡è¦åˆå§‹åŒ–çš„è³‡æ–™åº«
2. é¸æ“‡ Directus åˆå§‹åŒ–
3. å»ºç«‹è‡¨æ™‚ç¬¦è™Ÿé€£çµ
4. åŸ·è¡Œ `npx directus bootstrap`
5. è¨­å®šç®¡ç†å“¡å¸³è™Ÿ
6. æ¢å¾©åŸå§‹é€£çµ

## æŠ€è¡“ç´°ç¯€

### è³‡æ–™åº«æª¢æŸ¥é‚è¼¯

```javascript
function isDatabaseInitialized(dbPath) {
  if (!fs.existsSync(dbPath)) {
    return false;
  }
  const stats = fs.statSync(dbPath);
  // æª”æ¡ˆå¤§å° > 10KB è¦–ç‚ºå·²åˆå§‹åŒ–
  return stats.size > 10240;
}
```

### ç¬¦è™Ÿé€£çµç®¡ç†

åˆå§‹åŒ–éç¨‹ä¸­æœƒï¼š
1. å‚™ä»½ç¾æœ‰çš„ `db/current.db` é€£çµ
2. å»ºç«‹æŒ‡å‘æ–°è³‡æ–™åº«çš„è‡¨æ™‚é€£çµ
3. åŸ·è¡Œåˆå§‹åŒ–æ“ä½œ
4. æ¢å¾©åŸå§‹é€£çµ

### éŒ¯èª¤è™•ç†

- é…ç½®æª”æ¡ˆä¸å­˜åœ¨æˆ–æ ¼å¼éŒ¯èª¤
- ç¯„æœ¬è³‡æ–™åº«æå£æˆ–ä¸å¯è®€
- Directus åˆå§‹åŒ–å¤±æ•—
- æª”æ¡ˆæ¬Šé™å•é¡Œ

## æœ€ä½³å¯¦å‹™

### å»ºè­°å·¥ä½œæµç¨‹

1. **æº–å‚™ç¯„æœ¬**
   ```bash
   # ç¢ºä¿æœ‰å¯ç”¨çš„ç¯„æœ¬è³‡æ–™åº«
   node scripts/start-with-db.js  # é¸æ“‡åŸºç¤è³‡æ–™åº«
   # è¨­å®šå¥½åŸºæœ¬è³‡æ–™å’Œé…ç½®
   ```

2. **åˆå§‹åŒ–æ–°è³‡æ–™åº«**
   ```bash
   node scripts/init-database.js
   # é¸æ“‡è¦åˆå§‹åŒ–çš„è³‡æ–™åº«
   # é¸æ“‡åˆé©çš„ç¯„æœ¬
   ```

3. **åˆ‡æ›ä¸¦æ¸¬è©¦**
   ```bash
   node scripts/start-with-db.js
   # é¸æ“‡æ–°åˆå§‹åŒ–çš„è³‡æ–™åº«
   # æ¸¬è©¦åŠŸèƒ½æ˜¯å¦æ­£å¸¸
   ```

### è³‡æ–™åº«å‘½åè¦ç¯„

åœ¨ `db/databases.json` ä¸­ï¼š
```json
{
  "å®¢æˆ¶ä»£ç¢¼": {
    "path": "å®¢æˆ¶ä»£ç¢¼.db",
    "name": "å®¢æˆ¶å…¨å",
    "description": "å®¢æˆ¶è³‡æ–™åº«æè¿°"
  }
}
```

### å‚™ä»½å»ºè­°

```bash
# åˆå§‹åŒ–å‰å‚™ä»½é‡è¦è³‡æ–™åº«
cp db/important.db db/backup/important_$(date +%Y%m%d).db

# åˆå§‹åŒ–å¾Œé©—è­‰
ls -la db/
node scripts/start-with-db.js  # æ¸¬è©¦åˆ‡æ›åŠŸèƒ½
```

## æ•…éšœæ’é™¤

### é…ç½®æª”æ¡ˆå•é¡Œ

```bash
# æª¢æŸ¥é…ç½®æª”æ¡ˆæ ¼å¼
cat db/databases.json | jq .

# ä¿®å¾©è·¯å¾‘æ ¼å¼
# ç¢ºä¿ path ä¸åŒ…å« db/ å‰ç¶´
```

### ç¯„æœ¬è³‡æ–™åº«å•é¡Œ

```bash
# æª¢æŸ¥ç¯„æœ¬è³‡æ–™åº«ç‹€æ…‹
ls -la db/*.db
sqlite3 db/template.db ".tables"  # æª¢æŸ¥è³‡æ–™åº«çµæ§‹
```

### Directus åˆå§‹åŒ–å¤±æ•—

```bash
# æª¢æŸ¥ Directus ç’°å¢ƒ
cd server
npm list directus
npx directus --version

# æ‰‹å‹•åˆå§‹åŒ–
npx directus bootstrap --help
```

### æ¬Šé™å•é¡Œ

```bash
# macOS/Linux æ¬Šé™ä¿®å¾©
chmod 644 db/*.db
chmod 755 db/

# æª¢æŸ¥ç¬¦è™Ÿé€£çµæ¬Šé™
ls -la db/current.db
```

### æ¸…ç†å¤±æ•—çš„åˆå§‹åŒ–

```bash
# åˆªé™¤æå£çš„è³‡æ–™åº«æª”æ¡ˆ
rm db/failed.db

# æ¸…ç†å‚™ä»½æª”æ¡ˆ
rm db/current.db.backup

# é‡æ–°åˆå§‹åŒ–
node scripts/init-database.js
```

## èˆ‡å…¶ä»–å·¥å…·çš„æ•´åˆ

### èˆ‡ start-with-db.js é…åˆ

1. ä½¿ç”¨ `init-database.js` åˆå§‹åŒ–æ–°è³‡æ–™åº«
2. ä½¿ç”¨ `start-with-db.js` åˆ‡æ›åˆ°æ–°è³‡æ–™åº«
3. é€²è¡Œé–‹ç™¼å’Œæ¸¬è©¦

### è‡ªå‹•åŒ–è…³æœ¬ç¯„ä¾‹

```bash
#!/bin/bash
# æ‰¹æ¬¡åˆå§‹åŒ–å¤šå€‹å®¢æˆ¶è³‡æ–™åº«

CLIENTS=("client1" "client2" "client3")

for client in "${CLIENTS[@]}"; do
  echo "åˆå§‹åŒ– $client è³‡æ–™åº«..."
  # é€™è£¡éœ€è¦æ‰‹å‹•æ“ä½œï¼Œå› ç‚ºå·¥å…·æ˜¯äº’å‹•å¼çš„
  # å¯è€ƒæ…®é–‹ç™¼éäº’å‹•å¼ç‰ˆæœ¬
done
```

## æ³¨æ„äº‹é …

1. **è³‡æ–™å®‰å…¨**ï¼šåˆå§‹åŒ–æœƒè¦†è“‹ç¾æœ‰æª”æ¡ˆï¼Œè«‹å…ˆå‚™ä»½
2. **ç¯„æœ¬é¸æ“‡**ï¼šé¸æ“‡åˆé©çš„ç¯„æœ¬é¿å…è³‡æ–™çµæ§‹ä¸åŒ¹é…
3. **æ¬Šé™ç®¡ç†**ï¼šç¢ºä¿æœ‰è¶³å¤ æ¬Šé™å»ºç«‹å’Œä¿®æ”¹æª”æ¡ˆ
4. **æ¸¬è©¦é©—è­‰**ï¼šåˆå§‹åŒ–å¾Œå‹™å¿…æ¸¬è©¦è³‡æ–™åº«åŠŸèƒ½
5. **ç‰ˆæœ¬æ§åˆ¶**ï¼šä¸è¦å°‡ `.db` æª”æ¡ˆåŠ å…¥ç‰ˆæœ¬æ§åˆ¶
