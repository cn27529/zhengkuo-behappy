# Windows 符號連結問題解決指南

## 問題描述

在 Windows 環境下執行 `npm run db` 時，可能會遇到以下錯誤：

```
❌ 建立連結失敗: EPERM: operation not permitted, symlink 'zk.db' -> 'D:\Git\repository\zhengkuo-behappy\db\current.db'
⚠️ Windows 環境，嘗試使用複製...
✅ 已複製: zk.db -> current.db
```

這是因為 Windows 系統對符號連結有特殊的權限要求。

## 解決方案

### 方案 1: 啟用 Windows 開發者模式 (推薦)

1. **開啟 Windows 設定**
   - 按 `Win + I` 開啟設定
   - 或點擊開始菜單 → 設定

2. **進入開發人員設定**
   - Windows 10: 更新與安全性 → 開發人員專用
   - Windows 11: 隱私權與安全性 → 開發人員專用

3. **啟用開發人員模式**
   - 選擇「開發人員模式」
   - 確認啟用

4. **重新啟動電腦**
   - 重新啟動後即可使用符號連結

### 方案 2: 以管理員身份執行

1. **開啟管理員命令提示字元**
   - 按 `Win + X`，選擇「Windows PowerShell (系統管理員)」
   - 或搜尋「cmd」，右鍵選擇「以系統管理員身分執行」

2. **切換到專案目錄**
   ```cmd
   cd D:\Git\repository\zhengkuo-behappy
   ```

3. **執行資料庫切換命令**
   ```cmd
   npm run db
   ```

### 方案 3: 使用複製模式 (目前的備用方案)

如果無法啟用開發者模式或管理員權限，系統會自動使用複製模式：

- ✅ **優點**: 功能正常，不需要特殊權限
- ⚠️ **注意**: 文件是複製而非連結，修改不會同步

## 檢查系統支援

使用以下命令檢查您的系統符號連結支援狀態：

```bash
npm run check:symlink
```

這會顯示：
- 作業系統資訊
- 管理員權限狀態
- 開發者模式狀態
- 改善建議

## 技術細節

### Windows 符號連結限制

Windows 對符號連結有以下限制：

1. **權限要求**
   - 需要管理員權限
   - 或啟用開發者模式

2. **系統版本**
   - Windows Vista 以上支援符號連結
   - Windows 10/11 支援開發者模式

### 自動處理邏輯

腳本會按以下順序嘗試：

1. **Node.js 原生符號連結**
   - 如果有管理員權限或開發者模式

2. **Windows mklink 命令**
   - 如果有管理員權限

3. **文件複製 (備用方案)**
   - 當符號連結無法建立時

## 常見問題

### Q: 為什麼 macOS 沒有這個問題？

A: macOS 和 Linux 系統預設支援符號連結，不需要特殊權限。

### Q: 複製模式有什麼影響？

A: 
- 功能正常，資料庫可以正常使用
- 文件是獨立的，不會與原始文件同步
- 佔用額外的磁碟空間

### Q: 如何確認符號連結是否成功？

A: 執行 `npm run db` 後，查看輸出訊息：
- `✅ 符號連結建立成功` - 使用符號連結
- `✅ 文件複製成功` - 使用複製模式

### Q: 可以手動建立符號連結嗎？

A: 可以，使用管理員命令提示字元：

```cmd
cd db
mklink current.db zk.db
```

## 相關文件

- `scripts/start-with-db.js` - 主要的資料庫切換腳本
- `scripts/windows-symlink-helper.js` - Windows 符號連結輔助工具
- `db/databases.json` - 資料庫配置文件

## 更新日誌

- **v1.1**: 新增 Windows 符號連結輔助工具
- **v1.0**: 基本的複製備用方案