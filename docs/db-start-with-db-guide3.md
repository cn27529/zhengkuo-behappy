# Directus è³‡æ–™åº«åˆå§‹åŒ–å•é¡Œè§£æ±ºæŒ‡å—

## ğŸ”´ éŒ¯èª¤è¨Šæ¯

```
[11:44:47.404] ERROR: Database doesn't have Directus tables installed.
```

## ğŸ” å•é¡ŒåŸå› 

ç•¶ä½ ä½¿ç”¨ç¬¦è™Ÿé€£çµåˆ‡æ›è³‡æ–™åº«æ™‚ï¼Œå¦‚æœç›®æ¨™è³‡æ–™åº«æ˜¯**ç©ºæ–‡ä»¶**æˆ–**æœªåˆå§‹åŒ–çš„è³‡æ–™åº«**ï¼ŒDirectus æœƒå ±éŒ¯ï¼Œå› ç‚ºç¼ºå°‘å¿…è¦çš„è³‡æ–™è¡¨çµæ§‹ã€‚

### ç‚ºä»€éº¼æœƒå‡ºç¾ç©ºè³‡æ–™åº«ï¼Ÿ

åŸæœ¬çš„ `start-with-db.js` åœ¨è³‡æ–™åº«ä¸å­˜åœ¨æ™‚æœƒå‰µå»ºç©ºæ–‡ä»¶ï¼š

```javascript
if (!fs.existsSync(targetPath)) {
  fs.writeFileSync(targetPath, ""); // â† å‰µå»ºç©ºæ–‡ä»¶
}
```

Directus éœ€è¦å®Œæ•´çš„è³‡æ–™è¡¨çµæ§‹æ‰èƒ½é‹è¡Œï¼

## âœ… è§£æ±ºæ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šå¾ç¾æœ‰è³‡æ–™åº«è¤‡è£½ï¼ˆæ¨è–¦ï¼‰â­

å¦‚æœä½ å·²ç¶“æœ‰ä¸€å€‹åˆå§‹åŒ–å¥½çš„ Directus è³‡æ–™åº«ï¼ˆå¦‚ `data.db`ï¼‰ï¼Œé€™æ˜¯æœ€å¿«çš„æ–¹æ³•ã€‚

#### æ­¥é©Ÿ 1ï¼šä½¿ç”¨åˆå§‹åŒ–å·¥å…·

```bash
node scripts/init-database.js
```

#### æ­¥é©Ÿ 2ï¼šæŒ‰ç…§æç¤ºæ“ä½œ

```bash
ğŸ—„ï¸  å®¢æˆ¶è³‡æ–™åº«åˆå§‹åŒ–å·¥å…·

ğŸ“Š ç¾æœ‰è³‡æ–™åº«åˆ—è¡¨:
============================================================
  data.db                12.45 MB  âœ“ å·²åˆå§‹åŒ–
============================================================

è«‹è¼¸å…¥æ–°è³‡æ–™åº«åç¨±ï¼ˆä¸å« .db å¾Œç¶´ï¼‰: shaolin

ğŸ“‹ è«‹é¸æ“‡åˆå§‹åŒ–æ–¹å¼:
============================================================
  1. å¾ç¾æœ‰è³‡æ–™åº«è¤‡è£½ï¼ˆå¿«é€Ÿï¼Œæ¨è–¦ï¼‰
     a. å¾ data.db è¤‡è£½
  2. ä½¿ç”¨ Directus åˆå§‹åŒ–ï¼ˆæ…¢ï¼Œéœ€è¦è¨­å®šç®¡ç†å“¡ï¼‰
  0. å–æ¶ˆ
============================================================

è«‹é¸æ“‡ (1/2/0): 1
é¸æ“‡ç¯„æœ¬ (a): a

ğŸ“‹ å¾ç¯„æœ¬è¤‡è£½è³‡æ–™åº«...
  ç¯„æœ¬: data.db
  ç›®æ¨™: shaolin.db
  âœ“ è³‡æ–™åº«è¤‡è£½æˆåŠŸ
  âœ“ è³‡æ–™åº«å¤§å°: 12.45 MB

âœ… è³‡æ–™åº«å‰µå»ºæˆåŠŸ: shaolin.db
ğŸ’¡ ç¾åœ¨å¯ä»¥ä½¿ç”¨ start-with-db.js åˆ‡æ›åˆ°é€™å€‹è³‡æ–™åº«
```

#### æ­¥é©Ÿ 3ï¼šå•Ÿå‹•æœå‹™

```bash
node scripts/start-with-db.js
# é¸æ“‡: 1 (å°‘æ—å¯º)
```

### æ–¹æ¡ˆ 2ï¼šæ‰‹å‹•è¤‡è£½è³‡æ–™åº«

å¦‚æœä½ å·²ç¶“æœ‰ `data.db`ï¼Œå¯ä»¥æ‰‹å‹•è¤‡è£½ï¼š

```bash
# åœ¨ db ç›®éŒ„ä¸‹
cd db

# è¤‡è£½è³‡æ–™åº«
cp data.db shaolin.db
cp data.db ziyun.db
cp data.db zk.db

# æª¢æŸ¥æ–‡ä»¶
ls -lh *.db
```

### æ–¹æ¡ˆ 3ï¼šä½¿ç”¨ Directus Bootstrapï¼ˆè¼ƒæ…¢ï¼‰

å¦‚æœæ²’æœ‰ç¾æˆçš„è³‡æ–™åº«ï¼Œéœ€è¦ç”¨ Directus åˆå§‹åŒ–ï¼š

#### æ­¥é©Ÿ 1ï¼šå‰µå»ºç©ºè³‡æ–™åº«

```bash
touch db/shaolin.db
```

#### æ­¥é©Ÿ 2ï¼šè‡¨æ™‚æŒ‡å‘æ–°è³‡æ–™åº«

ä¿®æ”¹ `server/.env`ï¼š

```bash
DB_FILENAME="../db/shaolin.db"
```

#### æ­¥é©Ÿ 3ï¼šåŸ·è¡Œ Directus Bootstrap

```bash
cd server
npx directus bootstrap
```

é€™æœƒï¼š

1. å‰µå»ºæ‰€æœ‰å¿…è¦çš„è³‡æ–™è¡¨
2. è©¢å•ç®¡ç†å“¡å¸³è™Ÿè³‡è¨Š
3. åˆå§‹åŒ–è³‡æ–™åº«çµæ§‹

#### æ­¥é©Ÿ 4ï¼šæ¢å¾©ç¬¦è™Ÿé€£çµé…ç½®

```bash
# server/.env
DB_FILENAME="../db/current.db"
```

## ğŸ¯ æ¨è–¦å·¥ä½œæµç¨‹

### åˆæ¬¡è¨­ç½®ï¼ˆä¸€æ¬¡æ€§ï¼‰

```bash
# 1. åˆå§‹åŒ–ç’°å¢ƒ
node scripts/init-db-env.js

# 2. ç¢ºä¿æœ‰ä¸€å€‹åˆå§‹åŒ–å¥½çš„ç¯„æœ¬è³‡æ–™åº«
# å¦‚æœ db/data.db å·²å­˜åœ¨ä¸”å·²åˆå§‹åŒ–ï¼Œè·³éæ­¤æ­¥é©Ÿ
# å¦å‰‡ï¼Œéœ€è¦å…ˆå•Ÿå‹•ä¸€æ¬¡ Directus ä¾†å‰µå»º data.db

# 3. ç‚ºæ¯å€‹å®¢æˆ¶å‰µå»ºè³‡æ–™åº«ï¼ˆå¾ç¯„æœ¬è¤‡è£½ï¼‰
node scripts/init-database.js
# è¼¸å…¥: shaolin
# é¸æ“‡: 1 (å¾ data.db è¤‡è£½)

node scripts/init-database.js
# è¼¸å…¥: ziyun
# é¸æ“‡: 1 (å¾ data.db è¤‡è£½)

node scripts/init-database.js
# è¼¸å…¥: zk
# é¸æ“‡: 1 (å¾ data.db è¤‡è£½)
```

### æ—¥å¸¸ä½¿ç”¨

```bash
# é¸æ“‡å®¢æˆ¶ä¸¦å•Ÿå‹•
node scripts/start-with-db.js
# æˆ–
npm start
```

## ğŸ“‚ æ­£ç¢ºçš„ç›®éŒ„çµæ§‹

```
db/
â”œâ”€â”€ data.db          # ç¯„æœ¬è³‡æ–™åº«ï¼ˆå·²åˆå§‹åŒ–ï¼‰
â”œâ”€â”€ shaolin.db       # å°‘æ—å¯ºè³‡æ–™åº«ï¼ˆå·²åˆå§‹åŒ–ï¼‰
â”œâ”€â”€ ziyun.db         # ç´«é›²å¯ºè³‡æ–™åº«ï¼ˆå·²åˆå§‹åŒ–ï¼‰
â”œâ”€â”€ zk.db            # é®åœ‹å¯ºè³‡æ–™åº«ï¼ˆå·²åˆå§‹åŒ–ï¼‰
â””â”€â”€ current.db       # ç¬¦è™Ÿé€£çµ â†’ æŒ‡å‘ç•¶å‰ä½¿ç”¨çš„è³‡æ–™åº«
```

### æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦å·²åˆå§‹åŒ–

```bash
# æŸ¥çœ‹æ–‡ä»¶å¤§å°
ls -lh db/*.db

# å·²åˆå§‹åŒ–çš„è³‡æ–™åº«æ‡‰è©² > 10KB
-rw-r--r--  1 user  staff    12M  Jan 30 11:30 data.db      # âœ“ å·²åˆå§‹åŒ–
-rw-r--r--  1 user  staff    12M  Jan 30 11:45 shaolin.db   # âœ“ å·²åˆå§‹åŒ–
-rw-r--r--  1 user  staff     0B  Jan 30 11:50 empty.db     # âœ— æœªåˆå§‹åŒ–
```

## ğŸ”§ ä¿®æ”¹å¾Œçš„ start-with-db.js

æ–°ç‰ˆæœ¬æœƒè‡ªå‹•æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦å·²åˆå§‹åŒ–ï¼š

```javascript
function createSymlink(target, link) {
  const targetPath = path.join(DB_DIR, target);

  // æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦å­˜åœ¨
  if (!fs.existsSync(targetPath)) {
    log(`âŒ è³‡æ–™åº«ä¸å­˜åœ¨: ${target}`, "red");
    log(`ğŸ’¡ è«‹å…ˆåŸ·è¡Œ: node scripts/init-database.js`, "cyan");
    return false;
  }

  // æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦å·²åˆå§‹åŒ–
  if (!isDatabaseInitialized(targetPath)) {
    log(`âŒ è³‡æ–™åº«æœªåˆå§‹åŒ–: ${target}`, "red");
    log(`ğŸ’¡ è«‹å…ˆåŸ·è¡Œ: node scripts/init-database.js`, "cyan");
    return false;
  }

  // ç¹¼çºŒå‰µå»ºç¬¦è™Ÿé€£çµ...
}
```

## ğŸ¬ å®Œæ•´æ“ä½œç¤ºä¾‹

### å ´æ™¯ï¼šæ·»åŠ æ–°å®¢æˆ¶ã€Œæ™®é™€å¯ºã€

```bash
# 1. å‰µå»ºæ–°è³‡æ–™åº«
$ node scripts/init-database.js

è«‹è¼¸å…¥æ–°è³‡æ–™åº«åç¨±ï¼ˆä¸å« .db å¾Œç¶´ï¼‰: putuo

ğŸ“‹ è«‹é¸æ“‡åˆå§‹åŒ–æ–¹å¼:
  1. å¾ç¾æœ‰è³‡æ–™åº«è¤‡è£½ï¼ˆå¿«é€Ÿï¼Œæ¨è–¦ï¼‰
     a. å¾ data.db è¤‡è£½
  2. ä½¿ç”¨ Directus åˆå§‹åŒ–ï¼ˆæ…¢ï¼Œéœ€è¦è¨­å®šç®¡ç†å“¡ï¼‰
  0. å–æ¶ˆ

è«‹é¸æ“‡ (1/2/0): 1
é¸æ“‡ç¯„æœ¬ (a): a

âœ… è³‡æ–™åº«å‰µå»ºæˆåŠŸ: putuo.db

# 2. ä¿®æ”¹ start-with-db.js æ·»åŠ é¸é …
# åœ¨é¸å–®ä¸­æ·»åŠ :
#   4. æ™®é™€å¯º (putuo.db)

# 3. ä½¿ç”¨æ–°è³‡æ–™åº«
$ node scripts/start-with-db.js

è«‹é¸æ“‡è¦å•Ÿå‹•çš„å®¢æˆ¶è³‡æ–™åº«:
  1. å°‘æ—å¯º (shaolin.db)
  2. ç´«é›²å¯º (ziyun.db)
  3. é®åœ‹å¯º (zk.db)
  4. æ™®é™€å¯º (putuo.db)  â† æ–°å¢

é¸æ“‡: 4
âœ… åˆ‡æ›æˆåŠŸï¼Œæœå‹™å•Ÿå‹•ä¸­...
```

## âš ï¸ å¸¸è¦‹éŒ¯èª¤

### éŒ¯èª¤ 1ï¼šç©ºè³‡æ–™åº«

```
ERROR: Database doesn't have Directus tables installed.
```

**åŸå› **ï¼šè³‡æ–™åº«æ˜¯ç©ºæ–‡ä»¶  
**è§£æ±º**ï¼šä½¿ç”¨ `init-database.js` åˆå§‹åŒ–

### éŒ¯èª¤ 2ï¼šæ¬Šé™å•é¡Œ

```
Error: EACCES: permission denied
```

**åŸå› **ï¼šæ²’æœ‰è³‡æ–™åº«æ–‡ä»¶çš„å¯«å…¥æ¬Šé™  
**è§£æ±º**ï¼š

```bash
chmod 644 db/*.db
```

### éŒ¯èª¤ 3ï¼šç¬¦è™Ÿé€£çµæŒ‡å‘éŒ¯èª¤

```bash
# æª¢æŸ¥ç¬¦è™Ÿé€£çµ
ls -l db/current.db

# æ‡‰è©²é¡¯ç¤ºé¡ä¼¼:
# lrwxr-xr-x  1 user  staff  10 Jan 30 11:30 current.db -> shaolin.db

# å¦‚æœé¡¯ç¤ºéŒ¯èª¤ï¼Œæ‰‹å‹•é‡å»º
rm db/current.db
ln -s shaolin.db db/current.db
```

## ğŸ“ package.json æ·»åŠ å‘½ä»¤

```json
{
  "scripts": {
    "init:db": "node scripts/init-database.js",
    "start": "node scripts/start-with-db.js",
    "dev": "node scripts/start-with-db.js"
  }
}
```

ä½¿ç”¨ï¼š

```bash
# åˆå§‹åŒ–æ–°è³‡æ–™åº«
npm run init:db

# å•Ÿå‹•æœå‹™
npm start
```

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹åœ–

```
é¦–æ¬¡è¨­ç½®
  â”‚
  â”œâ”€ 1. åˆå§‹åŒ–ç’°å¢ƒ
  â”‚    â””â”€ node scripts/init-db-env.js
  â”‚
  â”œâ”€ 2. ç¢ºä¿æœ‰ç¯„æœ¬è³‡æ–™åº« (data.db)
  â”‚    â””â”€ å¦‚æœæ²’æœ‰ï¼Œå…ˆå•Ÿå‹•ä¸€æ¬¡ Directus
  â”‚
  â””â”€ 3. ç‚ºæ¯å€‹å®¢æˆ¶å‰µå»ºè³‡æ–™åº«
       â””â”€ node scripts/init-database.js (é‡è¤‡åŸ·è¡Œ)

æ—¥å¸¸ä½¿ç”¨
  â”‚
  â”œâ”€ node scripts/start-with-db.js
  â”‚    â”‚
  â”‚    â”œâ”€ æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦åˆå§‹åŒ– âœ“
  â”‚    â”œâ”€ ç§»é™¤èˆŠé€£æ¥
  â”‚    â”œâ”€ å‰µå»ºæ–°é€£æ¥
  â”‚    â””â”€ å•Ÿå‹•æ‰€æœ‰æœå‹™
  â”‚
  â””â”€ é–‹ç™¼å·¥ä½œ...
```

## âœ… æª¢æŸ¥æ¸…å–®

åœ¨å•Ÿå‹•æœå‹™å‰ï¼Œç¢ºèªï¼š

- [ ] `db/` ç›®éŒ„å­˜åœ¨
- [ ] è‡³å°‘æœ‰ä¸€å€‹å·²åˆå§‹åŒ–çš„ç¯„æœ¬è³‡æ–™åº«ï¼ˆå¦‚ `data.db`ï¼‰
- [ ] æ‰€æœ‰å®¢æˆ¶è³‡æ–™åº«éƒ½å·²åˆå§‹åŒ–ï¼ˆå¤§å° > 10KBï¼‰
- [ ] `server/.env` é…ç½®æ­£ç¢ºï¼š`DB_FILENAME="../db/current.db"`
- [ ] `rust-axum/.env` é…ç½®æ­£ç¢ºï¼š`DATABASE_URL=sqlite:../db/current.db`

## ğŸ†˜ é‚„æ˜¯æœ‰å•é¡Œï¼Ÿ

```bash
# æª¢æŸ¥è³‡æ–™åº«åˆ—è¡¨å’Œç‹€æ…‹
node scripts/init-database.js
# é¸æ“‡ 0 å–æ¶ˆï¼ŒåªæŸ¥çœ‹åˆ—è¡¨

# æ‰‹å‹•æ¸¬è©¦ Directus é€£æ¥
cd server
DB_FILENAME="../db/shaolin.db" npx directus start
```

## ğŸ“š ç›¸é—œæ–‡æª”

- [DATABASE-SWITCHING-GUIDE.md](./DATABASE-SWITCHING-GUIDE.md) - è³‡æ–™åº«åˆ‡æ›æŒ‡å—
- [start-with-db.md](./start-with-db.md) - å•Ÿå‹•è…³æœ¬ä½¿ç”¨èªªæ˜
- [init-db-env.md](./init-db-env.md) - ç’°å¢ƒåˆå§‹åŒ–èªªæ˜
